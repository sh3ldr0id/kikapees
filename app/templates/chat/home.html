{% extends 'base.html' %}

{% block head %}
<title>Chat - {{ other }}</title>
<style>
    body {
        height: 100vh;
    }
</style>
{% endblock %}

{% block body %}
<h1>Chats</h1>
<div class="d-flex flex-column rounded shadow border mt-3" style="width: 75%; height: 30%;">
    <div class="chats" id="chats" style="height: 100%; overflow-y: auto;"></div>
    <div class="d-flex align-items-center border-top shadow-top" style="width: 100%;">
        <input class="shadow-sm border m-2 p-2 bg-body-tertiary rounded" type="text" id="messageInput"
            style="width: 100%;">
        <input type="submit" id="sendButton"
            class="btn btn-success my-2 me-2 p-2 rounded border d-flex justify-content-center align-items-center"
            value="Send">
    </div>
</div>

<script type="module">
    import { io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js";

    const socket = io();

    const chats = document.getElementById("chats");
    const messageInput = document.getElementById("messageInput");
    
    socket.on('connect', function () {
        socket.emit('my event', { data: 'I\'m connected!' });
    });
    
    socket.on('new', function (message) {
        if (message.by == "{{ user }}") {
            chats.innerHTML += `
            <div class="msg-container d-flex justify-content-end" style="width: 100%;">
                <p class="rounded shadow-sm m-2 px-2 btn btn-success">${message.content}</p>
            </div>
            `
        } else {
            chats.innerHTML += `
            <div class="msg-container d-flex justify-content-start" style="width: 100%;">
                <p class="rounded shadow-sm m-2 px-2 btn btn-primary">${message.content}</p>
            </div>
            `
        }

        chats.scrollTop = chats.scrollHeight;
    });

    document.getElementById("sendButton").addEventListener("click", () => {
        socket.emit("new", {
            "token": "{{ token }}",
            "content": messageInput.value,
            "by": "{{ user }}",
            "timestamp": Math.floor(new Date().getTime() / 1000)
        })
    })

    document.getElementById("sendButton").addEventListener("click", () => {
        socket.emit("new", {
            "token": "{{ token }}",
            "content": messageInput.value,
            "by": "{{ user }}",
            "timestamp": Math.floor(new Date().getTime() / 1000)
        })
    })
</script>
{% endblock %}